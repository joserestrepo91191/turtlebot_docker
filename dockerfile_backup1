# ========================
# Turtlebot2 + ROS2 Humble (ARM64) - Jetson Nano
# Base liviana + Gazebo + RViz + Kobuki
# ========================

FROM arm64v8/ros:humble-ros-base

# ---------- SISTEMA BÁSICO ----------
RUN apt-get update && apt-get -y upgrade && \
    apt-get install -y \
        python3-pip \
        git \
        curl \
        gnupg2 \
        lsb-release \
        build-essential && \
    pip install setuptools==58.2.0 && \
    rm -rf /var/lib/apt/lists/*

# ---------- CLAVES Y FUENTES ROS2 (FIX de conflicto) ----------
RUN rm -f /etc/apt/sources.list.d/ros2* && \
    rm -f /usr/share/keyrings/ros-archive-keyring.gpg && \
    apt-get update && apt-get install -y curl gnupg2 lsb-release && \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
      -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [arch=arm64 signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
      http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" \
      | tee /etc/apt/sources.list.d/ros2.list > /dev/null && \
    apt-get update


# ---------- INSTALACIÓN DE PAQUETES ROS Y GAZEBO (ARM64 FIX) ----------
# ---------- INSTALACIÓN DE PAQUETES ROS Y GAZEBO (JETSON ARM64 FIX) ----------
RUN apt-get update && apt-get install -y wget lsb-release gnupg && \
    # Añadir repositorio oficial de Gazebo de OSRF
    wget https://packages.osrfoundation.org/gazebo.gpg -O /usr/share/keyrings/gazebo-archive-keyring.gpg && \
    echo "deb [arch=arm64 signed-by=/usr/share/keyrings/gazebo-archive-keyring.gpg] \
      http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" \
      | tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null && \
    apt-get update && \
    # Instalar Gazebo Classic 11 y paquetes ROS2 compatibles
    apt-get install -y \
        gazebo11 \
        libgazebo11-dev \
        ros-humble-rviz2 \
        ros-humble-laser-proc \
        ros-humble-urg-c \
        ros-humble-urg-node-msgs \
        ros-humble-joint-state-publisher \
        ros-humble-ament-cmake \
        ros-humble-diagnostic-updater \
        ros-humble-gazebo-ros-pkgs \
        ros-humble-gazebo-ros && \
    rm -rf /var/lib/apt/lists/*





# ---------- KOBUKI Y TURTLEBOT2 ----------
WORKDIR /ros2_ws/src

RUN git clone https://github.com/kobuki-base/kobuki_core.git && \
    git clone https://github.com/kobuki-base/kobuki_ros_interfaces.git && \
    git clone https://github.com/stonier/ecl_lite.git && \
    git clone https://github.com/stonier/ecl_tools.git && \
    git clone https://github.com/stonier/ecl_core.git && \
    git clone -b release/1.2.x https://github.com/stonier/sophus.git && \
    git clone https://github.com/kobuki-base/cmd_vel_mux.git && \
    git clone -b ros2-devel https://github.com/igrak34/urg_node.git && \
    git clone https://github.com/igrak34/kobuki_ros.git

# ---------- DEPENDENCIAS Y COMPILACIÓN ----------
WORKDIR /ros2_ws

RUN apt-get update && apt-get install -y python3-rosdep && \
    rosdep init && \
    rosdep update --include-eol-distros && \
    rosdep install --from-paths src --ignore-src -r -y && \
    /bin/bash -c "source /opt/ros/humble/setup.bash && colcon build --symlink-install" && \
    rm -rf /var/lib/apt/lists/*

# ---------- UDEV RULES PARA KOBUKI ----------
WORKDIR /ros2_ws/src/kobuki_core/
RUN cp 60-kobuki.rules /etc/udev/rules.d/ && \
    service udev reload && service udev restart

WORKDIR /ros2_ws
RUN /lib/systemd/systemd-udevd --daemon && udevadm control --reload-rules

# ---------- ENTORNO POR DEFECTO ----------
ENV RMW_IMPLEMENTATION=rmw_fastrtps_cpp
ENV ROS_DOMAIN_ID=42
ENV ROS_LOCALHOST_ONLY=0
ENV TZ=America/Bogota

CMD ["bash"]
